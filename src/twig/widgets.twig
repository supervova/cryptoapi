{% extends "partials/base.twig" %}

{% block config %}
  {{ parent() }}

  {% if ENV == 'development' %}
    {% set page = page|merge({
      lang: 'en',
      classes: 'is-widgets',
      styles: 'widgets.css',
      app: true
    }) %}
  {% endif %}

  {% set theme = widget.theme|default('dark') %}
  {% set rows = widget.rows|default(8) %}
{% endblock %}

{# MAIN CONTENT ------------------------------------------------------------- #}
{% block content %}

  <div class="e-container">
    <span id="iframe-title-tpl" hidden>{{ 'Crypto %s widget'|trans }}</span>
    <header class="e-main__header">
      <h1>
        {{ 'AI-Powered Crypto Widgets'|trans }}
        <span class="text-2ry">– {{ 'Add to Your Site'|trans }}</span>
      </h1>

      {% set active = active|default('signals') %}
      {% set tabs = [
        {id: 'signals', title: 'Signals'},
        {id: 'fgi', title: 'Fear & Greed'},
        {id: 'btc', title: 'BTC Chart'},
        {id: 'trindx', title: 'TRINDX'},
      ] %}

      <nav class="e-tabs-nav" role="tablist" aria-label="{{ 'Widget type'|trans }}" aria-orientation="horizontal">
        {% for t in tabs %}
          <button
            class="e-tabs-nav__item {% if active==t.id %}is-active{% endif %}"
            id="tab-{{ t.id }}"
            role="tab"
            data-target="#panel-{{ t.id }}"
            aria-selected="{{ active==t.id ? 'true' : 'false' }}"
            tabindex="{{ active==t.id ? '0' : '-1' }}"
          >
            <span class="phone-l:d-none">{{ loop.index }}</span>
            <span class="d-none phone-l:d-inline">{{ t.title|trans }}</span>
          </button>
        {% endfor %}
      </nav>
    </header>

    <div class="e-tabs e-widgets">
      <div class="tablet-l:flex" id="panel-{{ tabs[0].id }}">
        <section class="e-widgets__preview" aria-label="{{ 'Widget preview'|trans }}"></section>

        <aside class="e-widgets__config e-form" aria-label="{{ 'Widget settings'|trans }}">
          <div class="e-form__item">
            <label>{{ 'Theme'|trans }}:</label>
            <div class="e-segmented-control" role="group" aria-label="Тема">
              <button class="e-btn is-light" type="button" data-theme="light"{% if widget.theme=='light' %} aria-pressed{% endif %} title="{{ 'Light theme'|trans }}">
                {% include 'partials/icon.twig' with {name: 'sun'} %}
              </button>
              <button class="e-btn is-dark" type="button" data-theme="dark"{% if widget.theme=='dark' %} aria-pressed{% endif %} title="{{ 'Dark theme'|trans }}">
                {% include 'partials/icon.twig' with {name: 'moon'} %}
              </button>
            </div>
          </div>

          <div class="e-form__item" data-widget-config="signals">
            <label for="form-rows">{{ 'Number of lines (1–8)'|trans }}:</label>
            <input id="form-rows" class="e-number__input" type="number" min="1" max="8" value="{{ widget.rows }}" inputmode="numeric" />
          </div>

          <div>
            <label>{{ 'Code to embed on your website'|trans }}:</label>
            <pre class="e-widgets__code" id="form-code"><code></code></pre>

            <p class="text-2ry text-sm">
              {{ 'Copy and paste this code where you want the widget. Supports multiple widgets. They adapt to the parent container width (320–960 px).'|trans }}
            </p>

            <button class="e-button__copy e-btn" type="button" >{{ 'Copy code'|trans }}</button>
          </div>
        </aside>

      </div>
    </div>
  </div>
{% endblock %}

{% block body_suffix %}
  {{ parent() }}

  {% if ENV == 'development' %}
    <script>
      window.APP_CONFIG = window.APP_CONFIG || {};
      window.APP_CONFIG.env = 'development';
      window.APP_CONFIG.lang = '{{ widget.lang|default('en') }}';
      window.APP_CONFIG.affId = '{{ user.id|default('')|escape('js') }}';
      // Dev: всё берём локально (BrowserSync middleware мокает /widgets/signals)
      window.APP_CONFIG.assetsBasePrefix = "/";
      window.APP_CONFIG.widgetsBasePrefix = "/";
      APP_CONFIG.widgetAuthQuery = "widget_bypass=DEV123"; // ← имя/значение согласуйте с BE
    </script>
  {% else %}
    <script>
      window.APP_CONFIG = window.APP_CONFIG || {};
      window.APP_CONFIG.lang = '{{ widget.lang|default('en') }}';
      window.APP_CONFIG.affId = '{{ user.id|default('')|escape('js') }}';
      // Placeholder for production bypass token
      window.APP_CONFIG.widgetAuthQuery = "widget_bypass=PROD_STUB";
    </script>
  {% endif %}

  <script type="module" src="{{ site.assets_prefix }}/assets/js/pages/widgets.js?v={{ site.assets_version|default(1) }}"></script>
{% endblock %}
