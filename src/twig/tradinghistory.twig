{# trading.twig - Шаблон страницы торговых настроек #}
{% extends "partials/base.twig" %}

{% block config %}
  {{ parent() }}


{% endblock %}

{% block assets %}
  {{ parent() }}
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script
    defer
    src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"
    onerror="(function(){
      var s=document.createElement('script');
      s.src='/js/jquery-3.7.1.min.js';  // локальный fallback
      s.defer=true; document.head.appendChild(s);
    })()"
  ></script>
{% endblock %}

{% block content %}

<div class="e-container is-history">

  <header class="e-main__header">
    <h1>
      {{ 'Trading'|trans }}.
      <span class="text-2ry">{{ 'Transaction history'|trans }}</span>
    </h1>

    {% set trading_tabs = [
      {label: 'My Assets', link: 'trading', key: 'assets'},
      {label: 'History', link: 'trading?history', key: 'history'},
      {label: 'Settings', link: 'trading?settings', key: 'settings'}
    ] %}

    {% include 'partials/tabs-links.twig' with {
      tabs: trading_tabs,
      active: 'history',
      lang: page.lang
    } %}
  </header>

  <div class="e-date-picker">
    <p class="e-form__text-field">
      <input id="dateFrom" type="date">
      <label for="dateFrom">{{ 'From'|trans }}</label>
    </p>

    <p class="e-form__text-field">
      <input id="dateTo" type="date">
      <label for="dateTo">{{ 'To'|trans }}</label>
    </p>

    <div class="e-popover" data-role="popover">
      <button type="button" data-role="popover-summary" aria-expanded="false">
        {{ 'Quick select'|trans }}
      </button>
      <ul class="e-popover__body e-menu">
        {% set period_presets = [
          {"key": "today", "label": "Today"},
          {"key": "yesterday", "label": "Yesterday"},
          {"key": "thisweek", "label": "This week"},
          {"key": "lastweek", "label": "Last week"},
          {"key": "thismonth", "label": "This month"},
          {"key": "lastmonth", "label": "Last month"},
          {"key": "thisyear", "label": "This year"},
          {"key": "lastyear", "label": "Last year"}
        ] %}
        {% for item in period_presets %}
          <li class="e-menu__item">
            <button class="e-btn is-ghost quick-period" data-period="{{ item.key }}">{{ item.label|trans }}</button>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div id="historydata">
    <div class="e-loader is-spinner loadingspin"></div>

    <div class="trade-tabs" style="display:none;">
      <button class="trade-tab is-active" data-tab="sales">
        {{ 'Sales'|trans }} <span id="sales-count">0</span>
      </button>
      <button class="trade-tab" data-tab="purchases">
        {{ 'Purchases'|trans }} <span id="purchases-count">0</span>
      </button>
    </div>

    <div id="sales-content" class="trade-tab-content is-visible"></div>
    <div id="purchases-content" class="trade-tab-content"></div>
  </div>
</div>

<style>
.trade-tabs {
  display: inline-flex;
  gap: 0.5rem;
  margin: 1.5rem 0 1rem;
  background: rgba(255,255,255,0.04);
  border-radius: 10px;
  padding: 0.25rem;
}
.trade-tab {
  background: transparent;
  border: none;
  padding: 0.6rem 1.3rem;
  font-size: 0.95rem;
  color: rgba(255,255,255,0.7);
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.25s ease;
}
.trade-tab:hover[data-tab="sales"] { background: rgba(74,222,128,0.08); color: #4ade80; }
.trade-tab:hover[data-tab="purchases"] { background: rgba(59,130,246,0.08); color: #3b82f6; }
.trade-tab.is-active[data-tab="sales"] {
  background: rgba(74,222,128,0.15);
  color: #4ade80;
  box-shadow: 0 0 8px rgba(74,222,128,0.3);
}
.trade-tab.is-active[data-tab="purchases"] {
  background: rgba(59,130,246,0.15);
  color: #3b82f6;
  box-shadow: 0 0 8px rgba(59,130,246,0.3);
}
.trade-tab-content { display: none; animation: fadeIn 0.35s ease; }
.trade-tab-content.is-visible { display: block; }
@keyframes fadeIn {
  from {opacity: 0; transform: translateY(6px);}
  to {opacity: 1; transform: translateY(0);}
}

/* Бар прибыли */
.profit-cell { position: relative; text-align: right; padding-right: 0.5rem; }
.profit-bar {
  position: absolute;
  left: 0; bottom: 0;
  height: 3px;
  border-radius: 3px;
  opacity: 0.9;
  transition: all 0.25s ease;
}
.profit-cell:hover .profit-bar { height: 5px; opacity: 1; }

/* маленькая подпись под датой */
.subdate {
  display: block;
  font-size: 0.75rem;
  color: rgba(255,255,255,0.45);
  margin-top: 2px;
}

/* подпись "Продал: …" и подсветка проданных покупок */
.subdate-sold {
  display: block;
  font-size: 0.75rem;
  color: rgba(74,222,128,0.85);
  margin-top: 2px;
}
.row-sold {
  background: rgba(74,222,128,0.06);
}
.row-sold:hover {
  background: rgba(74,222,128,0.10);
}

/* базовая логика для поповера */
.e-popover__body { display: none; }
.e-popover.is-open .e-popover__body { display: block; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  let gettimer = null;
  let autoTimer = null;
  let isLoading = false;

  const USER_TZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const USER_TZ_OFFSET = new Date().getTimezoneOffset();

  // ---- ВРЕМЯ ----
  function parseServerMoscowToDate(dtString) {
    if (!dtString) return null;
    const m = /^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})$/.exec(dtString);
    if (!m) return null;
    const [_, Y, Mo, D, h, mi, s] = m.map(Number);
    const utcMs = Date.UTC(Y, Mo - 1, D, h - 3, mi, s);
    return new Date(utcMs);
  }
  function formatDateTimeLocalFromServer(dtString) {
    const d = parseServerMoscowToDate(dtString);
    if (!d) return '';
    d.setHours(d.getHours() + 2);
    return new Intl.DateTimeFormat(undefined, {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      timeZone: USER_TZ
    }).format(d);
  }
  function formatDateLocalFromServer(dtString) {
    const d = parseServerMoscowToDate(dtString);
    if (!d) return '';
    d.setHours(d.getHours() + 2);
    return new Intl.DateTimeFormat(undefined, {
      year: 'numeric', month: '2-digit', day: '2-digit',
      timeZone: USER_TZ
    }).format(d);
  }

  // ---- UI ----
  $(document).on('click', '[data-role="popover-summary"]', function (e) {
    e.stopPropagation();
    const $popover = $(this).closest('.e-popover');
    const isOpen = $popover.hasClass('is-open');
    $('.e-popover').removeClass('is-open');
    if (!isOpen) {
      $popover.addClass('is-open');
      $(this).attr('aria-expanded', 'true');
    } else {
      $(this).attr('aria-expanded', 'false');
    }
  });
  $(document).on('click', function (e) {
    if (!$(e.target).closest('.e-popover').length) {
      $('.e-popover').removeClass('is-open');
      $('[data-role="popover-summary"]').attr('aria-expanded', 'false');
    }
  });
  $(document).on('click', '.quick-period', function () {
    setPeriod($(this).data('period'));
    const $popover = $(this).closest('.e-popover');
    $popover.removeClass('is-open');
    $popover.find('[data-role="popover-summary"]').attr('aria-expanded', 'false');
  });

  $(document).on('click', '.trade-tab', function () {
    $('.trade-tab').removeClass('is-active');
    $(this).addClass('is-active');
    const tab = $(this).data('tab');
    $('.trade-tab-content').removeClass('is-visible');
    $('#' + tab + '-content').addClass('is-visible');
  });

  // ---- Утилиты ----
  function formatMoney(n){const num=Number(n);if(isNaN(num))return n;return num.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
  function formatNumberSmart(n){const num=Number(n);if(isNaN(num))return n;let fixed=num.toFixed(8);let[intPart,fracPart='']=fixed.split('.');fracPart=fracPart.replace(/0+$/,'');if(fracPart.length<2)fracPart=fracPart.padEnd(2,'0');return `${Number(intPart).toLocaleString('en-US')}.${fracPart}`;}

  function logScale(percent) {
    if (percent <= 0) return 0;
    if (percent <= 10) return (percent / 10) * 30;
    const minP = 10, maxP = 100, minW = 30, maxW = 100;
    const rel = (Math.log(percent) - Math.log(minP)) / (Math.log(maxP) - Math.log(minP));
    return Math.min(minW + rel * (maxW - minW), 100);
  }
  function profitColor(percent) {
    const p = Math.abs(Math.min(Math.max(percent, -100), 100));
    const factor = Math.pow(p / 100, 0.5);
    if (percent >= 0) {
      const hue = 120;
      const saturation = 30 + (factor * 70);
      const lightness = 25 + (factor * 35);
      return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    } else {
      const hue = 0;
      const saturation = 40 + (factor * 60);
      const lightness = 30 + (factor * 35);
      return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }
  }

  // ---- Периоды ----
  function setPeriod(period){
    const today=new Date();let from,to;
    switch(period){
      case 'today': from=to=today;break;
      case 'yesterday': from=to=new Date(today.setDate(today.getDate()-1));break;
      case 'thisweek':{const first=new Date();first.setDate(today.getDate()-today.getDay()+1);from=first;to=new Date();break;}
      case 'lastweek':{const first=new Date();first.setDate(today.getDate()-today.getDay()-6);from=first;const last=new Date(first);last.setDate(first.getDate()+6);to=last;break;}
      case 'thismonth':{from=new Date(today.getFullYear(),today.getMonth(),1);to=new Date();break;}
      case 'lastmonth':{from=new Date(today.getFullYear(),today.getMonth()-1,1);to=new Date(today.getFullYear(),today.getMonth(),0);break;}
      case 'thisyear':{from=new Date(today.getFullYear(),0,1);to=new Date();break;}
      case 'lastyear':{from=new Date(today.getFullYear()-1,0,1);to=new Date(today.getFullYear()-1,11,31);break;}
    }
    const fmt=d=>d.toISOString().split('T')[0];
    $('#dateFrom').val(fmt(from));$('#dateTo').val(fmt(to));
    clearTimeout(gettimer);
    gethistorydata();
  }

  // ---- Основной запрос ----
  function gethistorydata(){
    if (isLoading) return;
    isLoading = true;

    let fromDateStr=$('#dateFrom').val(),toDateStr=$('#dateTo').val();
    if(!fromDateStr||!toDateStr){ isLoading = false; return; }

    const fromDate=new Date(fromDateStr+'T00:00:00');
    const toDate=new Date(toDateStr+'T23:59:59');

    $.ajax({
      url:'./gettradinghistory.php',type:'POST',async:true,
      data:{from:fromDateStr,to:toDateStr,tz:USER_TZ,tzOffset:USER_TZ_OFFSET},
      success:function (response){
        const relultarr=$.parseJSON(response);
        if(relultarr[0]=='unlogged'){location.href='/{$user_lng}/auth';return;}
        if(relultarr[0]!=='OK'){ isLoading = false; return; }

        $('.loadingspin').remove();$('.trade-tabs').fadeIn(150);

        const deals=$.parseJSON(relultarr[1]);
        let totalProfit=0,totalSalesSum=0,totalPurchasesSum=0;

        const filteredSales = deals.filter(d=>{
          if(!d.saletime||!d.price_sale) return false;
          const sale = parseServerMoscowToDate(d.saletime);
          return sale>=fromDate && sale<=toDate;
        });
        const filteredPurchases = deals.filter(d=>{
          if(!d.purchasetime) return false;
          const buy = parseServerMoscowToDate(d.purchasetime);
          return buy>=fromDate && buy<=toDate;
        });

        const sales=filteredSales.sort((a,b)=>parseServerMoscowToDate(b.saletime)-parseServerMoscowToDate(a.saletime));
        const purchases=filteredPurchases.sort((a,b)=>parseServerMoscowToDate(b.purchasetime)-parseServerMoscowToDate(a.purchasetime));

        let htmlSales=`<div class="e-scroller"><table class="table has-2-liners"><thead><tr>
            <th>{{ 'Date and time of sale'|trans }}</th>
            <th>{{ 'Asset'|trans }}</th>
            <th class="table__cell is-num">{{ 'Qty'|trans }}</th>
            <th class="table__cell is-num">{{ 'Sell price'|trans }}</th>
            <th class="table__cell is-num">{{ 'Sell sum'|trans }}</th>
            <th class="table__cell is-num">{{ 'Profit'|trans }}</th>
          </tr></thead><tbody>`;

        for(const d of sales){
          const sumSale=d.qty*d.price_sale;
          const profit=d.profit||0;
          totalProfit+=profit; totalSalesSum+=sumSale;
          const profitPercent=(profit/(d.qty*d.price_buy))*100;
          const barWidth = logScale(Math.abs(profitPercent));
          const barColor = profitColor(profitPercent);
          htmlSales+=`<tr>
            <td>
              <time>${formatDateTimeLocalFromServer(d.saletime)}</time>
              ${d.purchasetime?`<span class="subdate">{{ 'Bought:'|trans }} ${formatDateLocalFromServer(d.purchasetime)}</span>`:''}
            </td>
            <td>${d.curr}</td>
            <td class="table__cell is-num">${d.qty}</td>
            <td class="table__cell is-num">${formatNumberSmart(d.price_sale)}</td>
            <td class="table__cell is-num">${formatMoney(sumSale)}</td>
            <td class="table__cell is-num profit-cell">
              ${formatMoney(profit)} <small>(${profitPercent.toFixed(1)}%)</small>
              <div class="profit-bar" style="width:${barWidth}%;background:${barColor};"></div>
            </td>
          </tr>`;
        }

        htmlSales+=`</tbody></table></div>
          <p class="text-right"><span class="text-2ry">{{ 'Total sales amount:'|trans }}</span> <b>$${formatMoney(totalSalesSum)}</b></p>
          <p class="text-right"><span class="text-2ry">{{ 'Profit for the selected period:'|trans }}</span> <b>$${formatMoney(totalProfit)}</b></p>
          <div class="historydata__footer">
            <p class="text-right"><span class="text-2ry">{{ 'All-time profit:'|trans }}</span> <b>$${formatMoney(relultarr[2])}</b></p>
            <small>{{ 'Do not refresh the page - the data in the table is updated automatically!'|trans }}</small>
          </div>`;

        let htmlPurchases=`<div class="e-scroller"><table class="table has-2-liners"><thead><tr>
            <th>{{ 'Date and time of purchase'|trans }}</th>
            <th>{{ 'Asset'|trans }}</th>
            <th class="table__cell is-num">{{ 'Qty'|trans }}</th>
            <th class="table__cell is-num">{{ 'Buy price'|trans }}</th>
            <th class="table__cell is-num">{{ 'Buy sum'|trans }}</th>
          </tr></thead><tbody>`;

        for(const d of purchases){
          const sumBuy=d.qty*d.price_buy; totalPurchasesSum+=sumBuy;
          const isSold = !!(d.price_sale && d.saletime);
          const saleDate = isSold ? formatDateLocalFromServer(d.saletime) : '';
          htmlPurchases+=`<tr class="${isSold ? 'row-sold' : ''}">
            <td>
              <time>${formatDateTimeLocalFromServer(d.purchasetime)}</time>
              ${isSold ? `<span class="subdate-sold">{{ 'Sold:'|trans }} ${saleDate}</span>` : ''}
            </td>
            <td>${d.curr}</td>
            <td class="table__cell is-num">${d.qty}</td>
            <td class="table__cell is-num">${formatNumberSmart(d.price_buy)}</td>
            <td class="table__cell is-num">${formatMoney(sumBuy)}</td>
          </tr>`;
        }

        htmlPurchases+=`</tbody></table></div>
          <p class="text-right"><span class="text-2ry">{{ 'Total purchase amount:'|trans }}</span> <b>$${formatMoney(totalPurchasesSum)}</b></p>`;

        $('#sales-content').html(htmlSales);
        $('#purchases-content').html(htmlPurchases);
        $('#sales-count').text(sales.length);
        $('#purchases-count').text(purchases.length);
      },
      complete:function(){
        isLoading = false;
        clearTimeout(autoTimer);
        autoTimer = setTimeout(gethistorydata, 15000); // автообновление каждые 15 секунд
      },
      error:function(){
        isLoading = false;
        clearTimeout(autoTimer);
        autoTimer = setTimeout(gethistorydata, 15000);
      }
    });
  }

  setPeriod('thisyear');
  $('#dateFrom,#dateTo').on('change',function(){
    clearTimeout(autoTimer);
    gethistorydata();
  });
});
</script>

{% endblock %}
