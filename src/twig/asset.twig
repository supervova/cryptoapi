{# asset.twig - Шаблон для страницы отдельного актива #}
{% extends "partials/base.twig" %}
{% import 'partials/macros.twig' as macros %}

{% block config %}
  {{ parent() }}

  {% if ENV == 'development' %}
    {% set page = page|merge(
      {
        app: true,
        classes: 'is-asset',
        styles: 'markets.css'
      }
    ) %}
  {% endif %}
{% endblock %}

{% block content %}
  {% set asset = page.asset %}

  <div class="e-container e-asset-details">
    <header class="e-main__header e-asset-details__header">

      <figure class="e-asset-details__figure" data-fallback="{{ asset.ticker|slice(0, 3)|upper }}">
        <img
          class="e-asset-details__icon"
          src="{{ asset.icon_path }}"
          data-fallback="{{ asset.ticker|slice(0, 3)|upper }}"
          alt="{{ asset.name|default(asset.ticker) }}"
        >
      </figure>

      <div class="e-asset-details__summary">
        <a class="e-eyebrow" href="{{ page.lang }}/markets">
          {% include 'partials/icon.twig' with {name: 'sm-chevron-left'} %}
          {{ 'Markets'|trans }}
        </a>
        <div class="e-row">
          <p class="e-asset-details__title tablet:d-none" data-asset-name aria-hidden="true">{{ asset.name|default(asset.ticker) }}</p>
          <h1 class="e-asset-details__symbol" data-asset-symbol>{{ asset.ticker|default('N/A') }}-USD</h1>
          <div class="e-asset-details__price" data-asset-price>
            <span data-asset-price-value>
              {% if asset.current_price is not null and asset.current_price != '' %}
                {{ macros.format_price(asset.current_price) }}
              {% else %}
                {{ asset.current_price|default('N/A') }}
              {% endif %}
            </span>
            {% if asset.change_24h_percent is not null %}
              {% set change_pct = asset.change_24h_percent %}
              <small
                class="e-asset-details__price-change {% if change_pct < 0 %}is-negative{% elseif change_pct > 0 %}is-positive{% endif %}"
                data-asset-price-change
              >
                {{ change_pct > 0 ? '+' : '' }}{{ change_pct|number_format(2, '.', ' ') }}%
              </small>
            {% endif %}
          </div>
        </div>
        <div class="e-row">
          <p class="e-asset-details__title d-none tablet:d-block" data-asset-name aria-hidden="true">{{ asset.name|default(asset.ticker) }}</p>
          <div class="e-asset-details__stats">
            <span>{{ 'O:'|trans }} <span class="nobr" data-asset-open data-stat="open">{{ asset.open_price|default('N/A') }}</span></span>
            <span>{{ 'Min:'|trans }} <span class="nobr" data-asset-low data-stat="min">{{ asset.low_price|default('N/A') }}</span></span>
            <span>{{ 'Max:'|trans }} <span class="nobr" data-asset-high data-stat="max">{{ asset.high_price|default('N/A') }}</span></span>
          </div>
        </div>
      </div>
    </header>

    <div class="e-asset-details__content">
      <div class="e-asset-details__chart" id="asset-chart">
        <p class="is-loading-state p-m text-center">{{ 'Loading chart data…'|trans }}</p>
      </div>

      <div class="e-asset-details__controls">
        <button class="btn has-tooltip is-hidden" data-role="chart-scroller" data-target="start" aria-label="{{ 'Period Start'|trans }}">
          {% include 'partials/icon.twig' with {name: 'sm-chevron-left'} %}
        </button>

        <div class="e-asset-details__period">
          {% set initial_period = page.js.initialChartPeriod|default('1d') %}
          {% set initial_timeframe = page.js.initialChartTimeframe|default('5m') %}

          {% set chart_periods = [
            {label: '1 Day', value: '1d', shortcut: '1D', checked: (initial_period == '1d')},
            {label: '48–24h Ago', value: '1pd', shortcut: 'D-2', checked: (initial_period == '1pd')},
            {label: '1 Month', value: '1M', shortcut: '1M', checked: (initial_period == '1M')},
            {label: '60–30d Ago', value: '1pM', shortcut: 'M-2', checked: (initial_period == '1pM')},
            {label: '1 Year', value: '1Y', shortcut: '1Y', checked: (initial_period == '1Y')},
            {label: '730–365d Ago', value: '1pY', shortcut: 'Y-2', checked: (initial_period == '1pY')}
          ] %}

          {% set chart_timeframes = [
            {label: '1 Minute', value: '1m', shortcut: '1m', checked: (initial_timeframe == '1m')},
            {label: '5 Minutes', value: '5m', shortcut: '5m', checked: (initial_timeframe == '5m')},
            {label: '15 Minutes', value: '15m', shortcut: '15m', checked: (initial_timeframe == '15m')},
            {label: '1 Hour', value: '1h', shortcut: '1H', checked: (initial_timeframe == '1h')},
            {label: '4 Hours', value: '4h', shortcut: '4H', checked: (initial_timeframe == '4h'), disabled: true},
            {label: '12 Hours', value: '12h', shortcut: '12H', checked: (initial_timeframe == '12h'), disabled: true},
            {label: '1 Day', value: '1d', shortcut: '1d', checked: (initial_timeframe == '1d'), disabled: true}
          ] %}

          {{ macros.chart_menu('chart-period', chart_periods, (initial_period|upper), 'Period'|trans) }}
          {{ macros.chart_menu('chart-timeframe', chart_timeframes, (initial_timeframe|trans), 'Timeframe'|trans) }}
        </div>

        <button class="btn has-tooltip is-hidden" data-role="chart-scroller" data-target="end" aria-label="{{ 'Period End'|trans }}" disabled>
          {% include 'partials/icon.twig' with {name: 'sm-chevron-right'} %}
        </button>
      </div>
    </div>
  </div>

  <footer class="e-stats-bar">
    {% set use_mock_stats = (ENV == 'development') %}
    {% if use_mock_stats %}
      {% set stat_trindx = 24.36 %}
      {% set stat_rsi30 = 1 %}
      {% set stat_forecast_mid = 118480.6 %}
      {% set stat_forecast_change = 3.78 %}
      {% set stat_forecast_min = 83200.44 %}
      {% set stat_forecast_max = 118480.6 %}
      {% set stat_current_price = asset.current_price is not null ? asset.current_price : 84915.13 %}
    {% else %}
      {% set stat_trindx = asset.trindx is not null ? asset.trindx : null %}
      {% set stat_rsi30 = asset.rating is not null ? asset.rating : null %}
      {% set stat_forecast_mid = asset.price_tomorrow_mid is not null ? asset.price_tomorrow_mid : null %}
      {% set stat_forecast_change = asset.tomorrow_change_pct is not null ? asset.tomorrow_change_pct : null %}
      {% set stat_forecast_min = asset.price_tomorrow_min is not null ? asset.price_tomorrow_min : null %}
      {% set stat_forecast_max = asset.price_tomorrow_max is not null ? asset.price_tomorrow_max : null %}
      {% set stat_current_price = asset.current_price is not null ? asset.current_price : null %}
    {% endif %}
    <ul class="e-stats-bar__list">
      <li class="d-none phone-l:d-flex">
        <span class="e-stats-bar__caption">TRINDEX:</span>
        <span class="e-stats-bar__value is-info" data-asset-trindx>
          {{ stat_trindx is not null ? stat_trindx : '—' }}
        </span>
      </li>
      <li>
        <details class="e-popover is-up" data-role="popover">
          <summary>
            <span class="e-stats-bar__caption">
              <span class="tablet:d-none">{{ 'Next-Day Forecast:'|trans }}</span>
              <span class="d-none tablet:d-inline">{{ 'Tomorrow’s Price Forecast:'|trans }}</span>
            </span>
            <span
              class="e-stats-bar__value{% if stat_forecast_mid is not null and stat_current_price is not null %} {{ stat_current_price < stat_forecast_mid ? 'is-success' : (stat_current_price > stat_forecast_mid ? 'is-error' : '') }}{% endif %}"
              data-asset-forecast-middle
            >
              {% if stat_forecast_mid is not null %}
                ${{ macros.format_price(stat_forecast_mid) }}
              {% else %}
                —
              {% endif %}
            </span>
          </summary>
          <div class="e-popover__body">
            <div class="e-popover__forecast">
              <strong
                class="{% if stat_forecast_mid is not null and stat_current_price is not null %}{{ stat_current_price < stat_forecast_mid ? 'is-success' : (stat_current_price > stat_forecast_mid ? 'is-error' : '') }}{% endif %}"
                data-asset-forecast-middle
              >
                {% if stat_forecast_mid is not null %}
                  {{ macros.format_price(stat_forecast_mid) }}
                {% else %}
                  —
                {% endif %}
              </strong>
              <span
                class="e-stats-bar__value{% if stat_forecast_change is not null %} {{ stat_forecast_change >= 0 ? 'is-success' : 'is-error' }}{% endif %}"
                data-asset-forecast-change
              >
                {% if stat_forecast_change is not null %}
                  {{ stat_forecast_change > 0 ? '+' : '' }}{{ stat_forecast_change|number_format(2, '.', ' ') }}%
                {% else %}
                  —
                {% endif %}
              </span>
            </div>
            <small
              class="e-popover__forecast-min-max"
              data-asset-forecast-min-max
              data-label="{{ 'Min–max:'|trans }}"
            >
              {{ 'Min–max:'|trans }}
              {% if stat_forecast_min is not null %}
                {{ macros.format_price(stat_forecast_min) }}
              {% else %}
                —
              {% endif %}
              —
              {% if stat_forecast_max is not null %}
                {{ macros.format_price(stat_forecast_max) }}
              {% else %}
                —
              {% endif %}
            </small>
            <small class="e-popover__forecast-timezone">
              {{ 'The forecast is provided in Central European Summer Time (UTC+2)'|trans }}<br>
              <a href="https://cryptoapi.ai/{{ page.lang }}/prediction/{{ asset.ticker }}">
                {{ 'History of previous price forecasts'|trans }}
              </a>
            </small>
          </div>
        </details>
      </li>
      <li class="d-none phone-l:d-flex">
        <span class="e-stats-bar__caption">{{ 'Rating'|trans }}:</span>
        <span class="e-stats-bar__value is-info" data-asset-rating>
          {{ stat_rsi30 is not null ? stat_rsi30 : '—' }}
        </span>
      </li>
    </ul>
  </footer>
{% endblock %}

{% block body_suffix %}
  {# page.js содержит все данные для window.APP_CONFIG #}
  {% set js_config = page.js %}
  {% set use_mock_stats_js = (ENV == 'development') %}
  {% set js_trindx = js_config.assetTrindx is not null ? js_config.assetTrindx : (use_mock_stats_js ? 24.36 : null) %}
  {% set js_rsi30 = js_config.assetRsi30 is not null ? js_config.assetRsi30 : (use_mock_stats_js ? 1 : null) %}
  {% set js_forecast_mid = js_config.assetPriceTomorrowMiddle is not null ? js_config.assetPriceTomorrowMiddle : (use_mock_stats_js ? 118480.6 : null) %}
  {% set js_forecast_change = js_config.assetTomorrowChangePct is not null ? js_config.assetTomorrowChangePct : (use_mock_stats_js ? 3.78 : null) %}
  {% set js_forecast_min = js_config.assetPriceTomorrowMin is not null ? js_config.assetPriceTomorrowMin : (use_mock_stats_js ? 83200.44 : null) %}
  {% set js_forecast_max = js_config.assetPriceTomorrowMax is not null ? js_config.assetPriceTomorrowMax : (use_mock_stats_js ? 118480.6 : null) %}

  <script id="js-translations" type="application/json">
    {{ {
      "assetDataNotFound": "Asset data not found."|trans,
      "couldNotLoadChartData": "Could not load chart data."|trans,
      "loadingChartData": "Loading chart data…"|trans,
      "noChartDataForPeriod": "No chart data available for the selected period."|trans,
      "noDataToDisplayChart": "No data to display chart."|trans,
      "serverFormatError": "Server sent data in an unexpected format or an error status."|trans,
      "unableToLoadChartData": "Unable to load chart data. Please go to the ‘Contact Us’ section and report the issue to support."|trans
    }|json_encode()|raw }}
  </script>

  <script>
    window.APP_CONFIG = {
      assetsBasePrefix:     '{{ js_config.assetsBasePrefix|default(site.assets_prefix)|escape("js") }}',
      currentLang:          '{{ js_config.currentLang|default(page.lang)|escape("js") }}',
      isDevelopment:        {{ js_config.isDevelopment ? 'true' : 'false' }},
      devApiUrl:            '{{ js_config.devApiUrl|escape("js") }}',

      pageType:             '{{ js_config.pageType|escape("js") }}',
      assetTicker:          '{{ js_config.assetTicker|escape("js") }}',
      assetName:            '{{ js_config.assetName|escape("js") }}',
      assetIconPath:        '{{ js_config.assetIconPath|escape("js") }}',
      assetOpenPrice:       '{{ js_config.assetOpenPrice|escape("js") }}',
      assetHighPrice:       '{{ js_config.assetHighPrice|escape("js") }}',
      assetLowPrice:        '{{ js_config.assetLowPrice|escape("js") }}',
      assetCurrentPrice:    '{{ js_config.assetCurrentPrice|escape("js") }}',
      assetChange24hPercent:'{{ js_config.assetChange24hPercent|escape("js") }}',
      assetPriceDayAgo:     {{ js_config.assetPriceDayAgo|json_encode()|raw }},
      assetPriceChange:     {{ js_config.assetPriceChange|json_encode()|raw }},
      assetPriceTomorrowMiddle: {{ js_forecast_mid|json_encode()|raw }},
      assetPriceTomorrowMin: {{ js_forecast_min|json_encode()|raw }},
      assetPriceTomorrowMax: {{ js_forecast_max|json_encode()|raw }},
      assetTomorrowChangePct: {{ js_forecast_change|json_encode()|raw }},
      assetTrindx:          {{ js_trindx|json_encode()|raw }},
      assetRsi30:           {{ js_rsi30|json_encode()|raw }},
      initialChartPeriod:   '{{ js_config.initialChartPeriod|escape("js") }}',
      initialChartTimeframe:'{{ js_config.initialChartTimeframe|escape("js") }}',
      initialCandleData:     {{ js_config.initialCandleData|json_encode()|raw }}
    };
  </script>


  {# CDN для Chart.js и его зависимостей #}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.9/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js" defer></script>

  <script src="{{ site.assets_prefix }}/assets/js/asset.js?v={{ site.assets_version|default(1) }}" type="module" defer></script>

  {{ parent() }}
{% endblock %}
