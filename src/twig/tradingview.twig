{# trading.twig - Шаблон страницы торговых настроек #}
{% extends "partials/base.twig" %}

  {% block config %}
  {{ parent() }}

  {% if ENV == 'development' %}
    {% set page = page|merge(
      {
        app: true,
        classes: 'is-trading',
        styles: 'trading.css'
      }
    ) %}

    {% set user = user|merge(
      {
        id: 1,
        allowed_assets: ['BTC']
      }
    ) %}
  {% endif %}
{% endblock %}

{% block assets %}
  {{ parent() }}
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script
    defer
    src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"
    onerror="(function(){
      var s=document.createElement('script');
      s.src='/js/jquery-3.7.1.min.js';  // локальный fallback
      s.defer=true; document.head.appendChild(s);
    })()"
  ></script>
{% endblock %}

{% block content %}

  <div class="e-container is-history">

    <header class="e-main__header">
      <h1>
        {{ 'Trading'|trans }}.
        <span class="text-2ry">{{ 'My Assets'|trans }}</span>
      </h1>

      {% set trading_tabs = [
        {label: 'My Assets', link: 'trading', key: 'assets'},
        {label: 'History', link: 'trading?history', key: 'history'},
        {label: 'Settings', link: 'trading?settings', key: 'settings'}
      ] %}

      {% include 'partials/tabs-links.twig' with {
        tabs: trading_tabs,
        active: 'assets',
        lang: page.lang
      } %}

    </header>

    <div id="warning" role="alert"></div>
    <label>
      <input id="hideSmallAssets" type="checkbox" onchange="gettradingdata()" checked>
      {{ 'Hide assets with total'|trans }}
      &lt; $0.01
    </label>

      <div id="tradingdata">
        <div class="e-loader is-spinner loadingspin"></div>
      </div>

  </div>
  <style>
    .blur-text {
      filter: blur(4px);
    }
  </style>
  <script>
    function formatNumberSmart(n) {
      const num = Number(n);
      if (isNaN(num))
        return n;


      // Приводим к числу с max 8 знаками после запятой
      let fixed = num.toFixed(8);

      // Разделяем целую и дробную части
      let [intPart, fracPart = ''] = fixed.split('.');

      // Удаляем незначащие нули справа
      fracPart = fracPart.replace(/0+$/, '');

      // Минимум 2 знака после точки
      if (fracPart.length < 2) {
        fracPart = fracPart.padEnd(2, '0');
      }

      return `${
        Number(intPart).toLocaleString('en-US')
      }.${fracPart}`;
    }
function gettradingdata() {
  $.ajax({
    url: './gettradingdata.php',
    type: 'POST',
    async: true,
    success: function (response) {
      relultarr = $.parseJSON(response);
      if (relultarr[0] == 'unlogged') {
        location.href = '/{$user_lng}/auth';
      } else if (relultarr[0] == 'disabled') {
        $('.loadingspin').remove();
        $('#tradingdata').html('<span style="color:var(--color-ink-text-error)"> {{ "Trading is disabled in the settings..."|trans }}</span>');
      } else if (relultarr[0] == 'OK') {
        $('.loadingspin').remove();
        let assets = $.parseJSON(relultarr[2]);
        let html = `
          <div class="e-scroller">
            <table>
              <thead>
                <tr>
                  <th>{{ 'Asset'|trans }}</th>
                  <th class="table__cell is-num">{{ 'Available'|trans }}</th>
                  <th class="table__cell is-num">{{ 'Current amount'|trans }}<br>$ {{ 'and price'|trans }}</th>
                  <th class="table__cell is-num">{{ 'Purchase amount'|trans }}<br>$ {{ 'and price'|trans }}</th>
                </tr>
              </thead>
              <tbody>
        `;

        portfolioTotal = 0;
        tradingTotal = 0;
        forecastTotalSum = 0;
        portfolioTotalBuy = 0;
        TotalProfit = relultarr[4];

        for (let asset in assets) {
          let data = assets[asset];
          let total = parseFloat(data.price) * parseFloat(data.available);
          let forecastTotal = data.forecastprice ? parseFloat(data.forecastprice) * parseFloat(data.available) : 0;
          let totalbuy = parseFloat(data.price) * parseFloat(data.available);

          let hasBuyPrice = data.price_buy && parseFloat(data.price_buy) > 0;

          if ($('#hideSmallAssets').is(':checked') && total < 0.01)
            continue;

          let colorStyle = '';
          if (hasBuyPrice) {
            totalbuy = parseFloat(data.price_buy) * parseFloat(data.available);
            if (parseFloat(data.price) > parseFloat(data.price_buy)) {
              colorStyle = 'style="color:#a8ffd2"';
            } else if (parseFloat(data.price) < parseFloat(data.price_buy)) {
              colorStyle = 'style="color:#f56c51"';
            }
          }

          let availableDisplay =
            Number.isInteger(parseFloat(data.available))
              ? Number(parseFloat(data.available)).toLocaleString('en-US')
              : formatNumberSmart(data.available);
let assetNameHtml = `<a href="/markets/${asset}" target="_blank">${asset}</a>`;
let assetBlur = ``;
if (data.stopsale == 1) {
  assetNameHtml = `<button class="btn" onclick="acceptintrade('${asset}',${formatNumberSmart(parseFloat(data.price_buy))})">${asset} <small style="color:#a8ffd2">{{ "Allow trading"|trans }}</small></button></a>`;
  assetBlur = ` blur-text`;
  colorStyle = '';
}
          html += `
            <tr>
              <td>${assetNameHtml}</td>
              <td class="table__cell is-num">${availableDisplay}</td>
            <td class="table__cell is-num ${assetBlur}" ${colorStyle}>
              ${formatNumberSmart(total)}<br>
              <small>
                ${formatNumberSmart(data.price)}
                ${
                  hasBuyPrice && data.forecastprice
                    ? `<br>
   <span class="forecast-tooltip">
     <span class="forecast-icon">?</span>
     <span class="forecast-popup">{{ "Minimum projected selling price"|trans }}</span>
     ${formatNumberSmart(data.forecastprice)}
   </span>`
                    : ''
                }
              </small>
            </td>
                <td class="table__cell is-num ${assetBlur}">${
                    asset === 'BNB'
                      ? `<small class="bnb-note">
                           {{ "Having BNB in your Binance spot balance reduces trading fees!"|trans }}
                         </small>`
                      : hasBuyPrice
                        ? `${formatNumberSmart(parseFloat(data.price_buy) * parseFloat(data.available))}<br><small>${formatNumberSmart(data.price_buy)}</small>`
                        : ''
              }</td>
            </tr>
          `;

          portfolioTotal += total;
          portfolioTotalBuy += totalbuy;
          tradingTotal += hasBuyPrice ? total : 0;
          forecastTotalSum += forecastTotal;
        }

        // вычисляем ожидаемую прибыль
        let expectedProfit = forecastTotalSum - portfolioTotalBuy;

        // добавляем итоговые строки
        html += `
          <tr>
            <td colspan="4" style="text-align:right; padding-top:1em;">
              {{ 'Portfolio amount'|trans }}: $${portfolioTotal.toFixed(2)}<br>
              {{ 'Total trading assets amount'|trans }}: $${tradingTotal.toFixed(2)}<br>
              <span style="color:#00b34d;">
              {{ 'Expected portfolio amount'|trans }}: $${forecastTotalSum.toFixed(2)}<br>
              {{ 'Minimum expected profit'|trans }}: $${expectedProfit.toFixed(2)}<br>
              </span>
              <span style="color:#f3ba2f;">
              {{ 'Previously received profit'|trans }}: $${TotalProfit}
              </span>
            </td>
          </tr>
        `;

        html += `
              </tbody>
            </table>
          </div>
          <small>{{ 'Do not refresh the page - the data in the table is updated automatically!'|trans }}</small>
        `;

        $('#tradingdata').html(html);
        $('#warning').html('');
        let successsmg = $.parseJSON(relultarr[5]);
        successsmg.forEach(function (warning) {
          $('#warning').html($('#warning').html() + '<div class="tradesuccess">' + warning + '</div>');
        });
        let warningsmg = $.parseJSON(relultarr[3]);
        warningsmg.forEach(function (warning) {
          $('#warning').html($('#warning').html() + '<div class="tradewraning">' + warning + '</div>');
        });
      }
      gettimer = setTimeout(function () {
        gettradingdata();
      }, 5000);
    },
    error: function () {
      gettimer = setTimeout(function () {
        gettradingdata();
      }, 1000);
    }
  });
}
    window.addEventListener('DOMContentLoaded', () => {
      gettradingdata();
    });
  </script>

<div id="tradeModal" class="modal__win" style="display:none;">
  <div class="modal__overlay" onclick="closeModal()"></div>
  <div class="modal__content">
    <h2>{{ 'Accept the asset'|trans }} <span id="assetname"></span></h2>
    <form id="tradeForm">
      <label>
        {{ 'Accept at a price:'|trans }}
        <input type="number" class="modal__input" id="tradePrice" step="0.00000001" min="0" lang="en">
      </label>
      <p class="note">
        {{ 'You can accept an asset at any price, including the one suggested by the system. Accepting an asset means granting permission to trade this asset. You may also choose not to accept the asset for trading — in that case, the system will keep it on your balance but will not perform any operations with it.'|trans }}
      </p>
      <div class="modal__actions">
        <button type="button" class="btn is-allow" onclick="confirmTrade(true)">{{ 'Enable Trading'|trans }}</button>
        <button type="button" class="btn is-deny" onclick="confirmTrade(false)">{{ 'Keep as is'|trans }}</button>
      </div>
    </form>
  </div>
</div>

<style>
  .modal__win {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000;
  }

  .modal__overlay {
    position: absolute;
    inset: 0;
  }

  .modal__content {
    position: relative;
    background: #1c1c1c;
    color: #ddd;
    padding: 2rem;
    border-radius: 14px;
    max-width: 480px;
    width: 90%;
    z-index: 3100;
    text-align: left;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  }

  .modal__label {
    display: block;
    margin-bottom: 1rem;
    color: #ccc;
  }

  .modal__input {
    width: 100%;
    background: #2a2a2a;
    color: #fff;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 0.5rem;
    font-size: 1rem;
    margin-top: 0.3rem;
  }

  .modal__note {
    font-size: 0.9rem;
    color: #aaa;
    line-height: 1.5;
    margin-bottom: 1.5rem;
  }

  .modal__actions {
    display: flex;
    justify-content: center;
    gap: 1rem;
  }

  .is-allow {
    color:#a8ffd2
  }
  
.tradewraning {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  background: linear-gradient(135deg, rgba(255, 80, 80, 0.12), rgba(255, 80, 80, 0.05));
  border: 1px solid rgba(255, 90, 90, 0.3);
  border-left: 4px solid #ff5b5b;
  color: #f2dede;
  font-size: 0.95rem;
  line-height: 1.4;
  padding: 12px 16px;
  border-radius: 10px;
  box-shadow: 0 0 8px rgba(255, 90, 90, 0.1);
  margin-bottom: 12px;
}

.tradewraning::before {
  content: "!";
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background-color: #ff5b5b;
  color: #111;
  font-weight: 700;
  font-size: 0.9rem;
  box-shadow: 0 0 6px rgba(255, 90, 90, 0.5);
  margin-top: 2px;
}
/* Тёмная тема — адаптация под общий стиль */
@media (prefers-color-scheme: dark) {
  .tradewraning {
    background: linear-gradient(135deg, rgba(255, 80, 80, 0.12), rgba(255, 80, 80, 0.03));
    color: #ffecec;
  }
}
.tradesuccess {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  background: linear-gradient(135deg, rgba(120, 255, 180, 0.10), rgba(120, 255, 180, 0.04));
  border: 1px solid rgba(120, 255, 180, 0.25);
  border-left: 4px solid #4dff9a;
  color: #d9ffeb;
  font-size: 0.95rem;
  line-height: 1.4;
  padding: 12px 16px;
  border-radius: 10px;
  box-shadow: 0 0 8px rgba(120, 255, 180, 0.1);
  margin-bottom: 12px;
}

.tradesuccess::before {
  content: "✓";
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background-color: #4dff9a;
  color: #111;
  font-weight: 700;
  font-size: 0.9rem;
  box-shadow: 0 0 6px rgba(120, 255, 180, 0.5);
  margin-top: 2px;
}
/* Адаптация под тёмную тему */
@media (prefers-color-scheme: dark) {
  .tradesuccess {
    background: linear-gradient(135deg, rgba(120, 255, 180, 0.12), rgba(120, 255, 180, 0.03));
    color: #e8fff3;
  }
}

.bnb-note {
  display: inline-block;
  max-width: 180px; /* ограничиваем ширину, чтобы ячейка не растягивалась */
  white-space: normal; /* разрешаем перенос строк */
  font-size: 0.8rem;
  line-height: 1.3;
  color: #4dff9a;
  opacity: 0.9;
  font-style: italic;
  text-align: right;
}
.forecast-tooltip {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  color: #4dff9a;
  cursor: help;
}

.forecast-icon {
  display: inline-flex;
  justify-content: center;
  align-items: center;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background-color: #00b34d;
  color: #111;
  font-weight: 700;
  font-size: 0.8rem;
  line-height: 1;
}

.forecast-popup {
  visibility: hidden;
  opacity: 0;
  position: absolute;
  top: -35px;
  left: 22px;
  background: #00b34d;
  color: #000;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.75rem;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  transition: opacity 0.2s ease, visibility 0.2s ease;
  z-index: 1000;
}

.forecast-icon:hover + .forecast-popup {
  visibility: visible;
  opacity: 1;
}
</style>

<script>
  let currentAsset = null;

  function acceptintrade(asset, price) {
    currentAsset = asset;
    document.getElementById('assetname').innerHTML = asset;
    document.getElementById('tradePrice').value = price || 0;
    document.getElementById('tradeModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('tradeModal').style.display = 'none';
  }

  function confirmTrade(allow) {
    const price = document.getElementById('tradePrice').value;
    closeModal();

    if (allow) {
      $.ajax({
        url: './acceptintrade.php',
        type: 'POST',
        data: { asset: currentAsset, price: price },
        success: function (response) {
          if (response != 'OK')
          {
              location.reload();
              return;
          }
          gettradingdata();
        },
        error: function () {
          alert('{{ "Error sending request" | trans }}');
        }
      });
    }
  }
</script>

{% endblock %}
