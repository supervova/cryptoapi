---
cssClass: wide-table
---

# Функции авторизации

TODO: Убедиться, что серверные скрипты (register.php, initmsgreg.php, index.php) работают в соответствии с ожидаемыми параметрами и форматами ответов.

|                                  | Назначение                                                                                                                                                                                                                                                                                | Замена                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                  | **Управление ячейками**                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ~~`gotab(tab)`~~                 | Управляет визуальным переключением между различными вкладками аутентификации (Вход, Регистрация, Сброс пароля), добавляя/удаляя класс active и прокручивая страницу вверх.                                                                                                                | `AuthModule.switchTab`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ~~`quickreg()`~~                 | Переключает вид на вкладку "Регистрация", вызывая gotab('signup')                                                                                                                                                                                                                         | Функции-переключатели `quickreg()`, `loginform()`, `forgotform()` из auth.html заменяются логикой внутри `AuthModule.initEventListeners`, которая слушает клики по кнопкам переключения вкладок ([data-target]) и вызывает `switchTab`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ~~`loginform()`~~                | Переключает вид на вкладку "Вход", вызывая gotab('signin')                                                                                                                                                                                                                                | ☝️                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| ~~`forgotform()`~~               | Переключает вид на вкладку "Сброс пароля", вызывая gotab('resetpwd')                                                                                                                                                                                                                      | ☝️                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|                                  | **Обработка основных действий: вход, регистрация, сброс пароля**                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ~~`dologinlf()`~~                | Обрабатывает действие "Войти". Получает email и пароль, выполняет преобразование ROT13 над паролем (примечание: это небезопасное шифрование), отправляет учетные данные на register.php через AJAX ($.post) и перенаправляет в случае успеха или отображает сообщение об ошибке.          | `AuthModule.performAuthAction('login')`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ~~`complitereglf()`~~            | Обрабатывает действие "Зарегистрироваться". Получает регистрационные данные (email, пароль, имя и т.д.), вычисляет смещение часового пояса клиента, отправляет данные на register.php через AJAX ($.post), и в случае успеха вызывает mailmsg; в противном случае отображает ошибку       | `AuthModule.performAuthAction('signup')`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ~~`dorememberf()`~~              | Обрабатывает действие "Сброс пароля". Получает адрес электронной почты, отправляет его на register.php через AJAX ($.post), и в случае успеха вызывает mailmsg для показа подтверждения; в противном случае отображает ошибку.                                                            | `AuthModule.performAuthAction('resetpwd')`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ~~`donext()`~~                   | Определяет, какая форма (Вход, Регистрация, Сброс пароля) активна в данный момент, и вызывает функцию checkagreement перед выполнением соответствующей функции отправки (dologinlf, complitereglf или dorememberf).                                                                       | Заменяется логикой внутри `AuthModule.initEventListeners`, которая определяет активную вкладку и вызывает соответствующий `performAuthAction` при клике на основную кнопку отправки.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ~~`checkagreement(nextscript)`~~ | Проверяет, установлен ли флажок "Пользовательское соглашение". Если нет, показывает всплывающее окно для подтверждения. Если пользователь соглашается (или флажок уже был установлен), выполняет вызов функции, переданной как nextscript (с помощью eval).                               | заменяется проверками `document.getElementById(SELECTORS.elements.userAgreement).checked` внутри обработчиков событий в `AuthModule.initEventListeners` перед выполнением критических действий (основная кнопка, OAuth, мессенджеры). Вместо `bootpopup` используется `showToast` для предупреждения.<br>**TODO:** cделать еще строковую валидацию                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|                                  | **Вход oAuth**                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ~~`googleoauth()`~~              | Инициирует процесс входа через Google OAuth после вызова `checkagreement`                                                                                                                                                                                                                 | Заменяется обработчиками кликов на элементах [data-oauth] внутри `AuthModule.initEventListeners`. Проверка соглашения встроена в эти обработчики.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ~~`facebookoauth()`~~            | Инициирует процесс входа через Facebook OAuth после вызова `checkagreement`                                                                                                                                                                                                               | ❌                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ~~`yandexoauth()`~~              | Инициирует процесс входа через Yandex OAuth после вызова `checkagreement`                                                                                                                                                                                                                 | ❌                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                  | **Вход через мессенджеры**                                                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ~~`preloginmsg(msgname)`~~       | Действует как предварительный шаг для входа через мессенджер, сначала вызывая `checkagreement`, а затем переходя к вызову `loginmsg`                                                                                                                                                      | Заменяется обработчиком клика на `[data-msg]` в `AuthModule.initEventListeners`, который включает проверку соглашения перед показом модального окна.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ~~`loginmsg(msgname)`~~          | Инициирует процесс входа через мессенджеры (Viber, Telegram). Запрашивает уникальный код (msgcode) с сервера (`initmsgreg.php`), отображает код и инструкции в модальном окне (`#loginmsgwin`) и запускает процесс опроса через `checkmsgcode.func`                                       | Часть, отвечающая за показ окна (`#loginmsgwin`) и нужной секции (`#telegramdiv`), реализована в `AuthModule.initEventListeners`. <br>- `startMessengerPolling` вызывается после успешного получения кода от `initmsgreg.php`. Она отображает код и таймер, показывает диалог (`#loginmsgwin.showModal()`) и запускает интервал и таймаут.<br>- `poll` – асинхронная функция, которая делает запрос к `initmsgreg.php` с параметром `checkinit`. Она обрабатывает ответы '`LOG`' (успех -> редирект), 'OK' (продолжить опрос), или ошибку (остановка опроса, показ сообщения).<br>- `stopMessengerPolling` очищает таймеры, сбрасывает флаги, закрывает диалог (`#loginmsgwin.close()`) и опционально отправляет запрос отмены на сервер.<br>- Добавлен флаг `msgPollingActive` для предотвращения параллельных запусков опроса.<br>- Используются константы `POLLING_INTERVAL_MS` и `POLLING_TIMEOUT_MS` для настройки интервала и таймаута. |
| ~~`cancelauth()`~~               | Отправляет AJAX-запрос на initmsgreg.php для отмены ожидающего процесса входа через мессенджер, идентифицированного msgcode, и скрывает модальное окно входа через мессенджер (#loginmsgwin)                                                                                              | Заменяется обработчиком клика на `[data-action="cancelauth"]` в AuthModule.initEventListeners                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ~~`checkmsgcode.func()`~~        | (Метод внутри объекта checkmsgcode) Периодически опрашивает сервер (initmsgreg.php) через AJAX, чтобы проверить, был ли завершен пользователем вход через мессенджер, связанный с msgcode. Перенаправляет при успехе ('LOG'), обрабатывает тайм-ауты и ошибки.                            | см. `loginmsg`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|                                  | **Работа с email-подтверждением**                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ~~`mailmsg(argretry)`~~          | Отображает модальное окно (#sended), информирующее пользователя об отправке email (для верификации или сброса пароля). Запускает таймер mailcountdown и управляет пользовательским интерфейсом для возможных повторных попыток. Если argretry равно 0, закрывает процесс и перенаправляет | Логика показа модального окна `#sended` и запуска `mailCountdown` теперь находится внутри `AuthModule.performAuthAction` (для `signup` и `resetpwd`). Закрытие окна и повторная отправка (`[data-action="resend"]`, `[data-action="closeMail"]`) обрабатываются в `AuthModule.initEventListeners`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| ~~`mailcountdown(stopsec)`~~     | Реализует таймер обратного отсчета (в секундах), отображаемый в элементе #waitsec. Используется после предполагаемой отправки email, чтобы предотвратить немедленные повторные отправки. Управляет видимостью элементов для повторной отправки/попытки                                    | `AuthModule.mailCountdown(seconds)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|                                  | **Вспомогательные и UI функции**                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ~~`js_translate(str)`~~          | перевод                                                                                                                                                                                                                                                                                   | `t(key, params = {})`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ~~`docancel()`~~                 | Перенаправляет пользователя на URL возврата `{$returl}`, фактически отменяя процесс аутентификации.                                                                                                                                                                                       | ❌ Кнопка Cancel является актором процесса закрытия диалоговых окон и в иных случаях нарушает метнальные шаблоны пользоваетля и снижает конверсию. Для возвращения на предыдущую страницу стандартный UX — кнопка назад в браузере. Но если зачем-то понадобится — заменяется обработчиком клика на кнопке отмены (`#cancellogin`) в `AuthModule.initEventListeners`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ~~`showoath()`~~                 | Показывает или скрывает раздел OAuth (вход через сторонние сервисы) (`#oauthdiv`) в зависимости от того, активна ли вкладка Входа/Регистрации (Показать) или вкладка Сброса пароля (Скрыть)                                                                                               | ❌ Лишняя логика интерфейса. Кнопки авторизации вставляют инклюдом в оба раздела, в которых используются.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ~~`generatepasswordlf()`~~       | Запрашивает сгенерированный пароль с сервера (index.php?genpwd=10) через AJAX ($.post) и заполняет поле пароля в форме регистрации полученным результатом, делая его видимым                                                                                                              | заменяется обработчиком клика на `[data-action="generatepassword"]` в `AuthModule.initEventListeners`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ~~`showpasswordlf`~~             | Чекбокс показа/скрытия пароля                                                                                                                                                                                                                                                             | Заменяется кнопкой `[data-role="password-toggle"]` и соответствующим обработчиком в `AuthModule.initEventListeners`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |

## Подробнее о новых функциях

|                                      | назначение                                                                                                                                                                                                                                                                                                                                                                    |
| ------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `AuthModule (IIFE)`                  | Немедленно вызываемое функциональное выражение (Immediately Invoked Function Expression), которое инкапсулирует всю логику аутентификации в модуль.                                                                                                                                                                                                                           |
| `AuthModule.makeRequest(url, data)`  | Отправляет POST-запрос с использованием fetch API по указанному URL с предоставленными данными. Возвращает текст ответа в виде Promise. Обрабатывает базовые ошибки и показывает всплывающее уведомление (toast) при сбое                                                                                                                                                     |
| `AuthModule.switchTab(tabId)`        | Управляет визуальным переключением между вкладками аутентификации (Вход, Регистрация, Сброс пароля), переключая классы (is-open) и атрибуты ARIA.                                                                                                                                                                                                                             |
| `AuthModule.mailCountdown(seconds)`  | Подобно функции в auth.html, реализует таймер обратного отсчета для функциональности повторной отправки email, обновляя пользовательский интерфейс соответствующим образом                                                                                                                                                                                                    |
| `AuthModule.performAuthAction(type)` | Централизованная функция для обработки основной логики действий 'login' (вход), 'signup' (регистрация) и 'resetpwd' (сброс пароля). Собирает данные из соответствующей формы, вызывает makeRequest для связи с сервером (register.php) и обрабатывает ответ (перенаправления, показ модального окна email или отображение ошибок в форме)                                     |
| `AuthModule.initEventListeners()`    | Настраивает слушатели событий (используя делегирование событий на document.body) для всех интерактивных элементов: переключение вкладок, клики OAuth, клики для входа через мессенджеры, действия в модальных окнах, отправка основной формы, генерация/переключение видимости пароля и отмена. Включает проверку пользовательского соглашения перед критическими действиями. |
| `AuthModule.init()`                  | Инициализирует модуль, настраивая слушатели событий после загрузки DOM (DOMContentLoaded)                                                                                                                                                                                                                                                                                     |
| `showToast(message, type = 'info')`  | Отображает неблокирующее уведомление (toast) пользователю, используется здесь для показа ошибок или предупреждений (например, о необходимости принять соглашение)                                                                                                                                                                                                             |
